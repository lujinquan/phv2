<style>
  .page-tab-content{ background: none;padding: 0;overflow-x: hidden;}
</style>
<div class="layui-row layui-col-space10 j-row-box">
  <div class="layui-col-md9 j-back-gray j-border-radius10 clearfix">
    <form class="layui-form" action="transfer" method="post">
      <div class="grid-demo j-back-white clearfix j-left">
        <div class="layui-card">
          <h1 class="j-card-header">问题描述：</h1>
          <div class="layui-card-body">
            {$data_info['remark']}
          </div>
          <h1 class="j-card-header">附件：</h1>
          <div class="layui-card-body clearfix">
            <ul class="j-enclosure-box">
              <li>
                <img src="__ADMIN_IMG__/theme.png" />
              </li>
              <li>
                <img src="__ADMIN_IMG__/theme.png" />
              </li>
            </ul>
          </div>
          <h1 class="j-card-header">状态：</h1>
          <div class="layui-card-body clearfix">
            <!-- 状态条显示 S -->
          <!-- <div class="j-status-bar">
            <ul>
              {volist name="$data_info['jsondata']" id="v"}
              <li class="layui-col-xs2">
                <i class="layui-icon layui-icon-ok-circle"></i>
                <p>{$systemusers[$v['FromUid']]}</p>
              </li>
              {/volist}
            </ul>
          </div> -->
          <!-- 状态条显示 E -->
          <div class="j-axis-main clearfix">
            <ul class="time-axis">
              {volist name="data_info['jsondata']" id="v"}
              <li class="time-axis-item">
                <div class="time-axis-date"><span></span></div>
                <div class="time-axis-title">
                  <h1>【{$systemusers[$v['FromUid']]}】 于 {$v['Time']|date='Y-m-d H:i'} {$v['Action']} {if condition="$v['ToUid']"} 【{$systemusers[$v['ToUid']]}】 {/if}</h1>
                  <div class="j-remarks">
                    备注：{$v['Desc']}
                  </div>
                </div>
              </li>
              {/volist}
            <ul>
          </div>
          </div>
          <h1 class="j-card-header">回复：</h1>
          <div class="layui-card-body clearfix">
            <div  class="j-reply-textarea clearfix">
              <textarea name="replay" rows="6"></textarea>
              <div class="j-upload-size">
                <i class="layui-icon layui-icon-picture"></i><span>上传附件</span>
              </div>
            </div>
          </div>
        </div>
      </div>
        <input type="hidden" name="id" value="{$data_info['id']}">
        <div class="layui-form-item">
          <div class="j-form-box clearfix">
            <div class="fl">
              <a href="{:url('index')}" class="layui-btn layui-btn-normal">返回</a>
            </div>
            <div class="fr">
          <button type="button" class="layui-btn layui-btn-orange" id="handover" >转交工单</button>
          <button type="button" class="layui-btn layui-btn-grass" id="complete" >完成工单</button>
        </div>
      </div>  
    </div>
  </form>
</div>
<div class="layui-col-md3 j-back-gray j-border-radius10 clearfix">
  <div class="grid-demo j-back-white j-info-box clearfix j-right">
    <dl class="clearfix">
      <dt><i class="layui-icon layui-icon-read"></i>工单信息</dt>
      <dd>
        <h1>工单编号</h1>
        <p>{$data_info['op_order_number']}</p>
      </dd>
      <dd>
        <h1>创建时间</h1>
        <p>{$data_info['ctime']}</p>
      </dd>
      <dd>
        <h1>发起人</h1>
        <p>{$data_info['nick']}</p>
      </dd>
      <dd>
        <h1>运行人员</h1>
        <p>{$data_info['jsondata'][1]?$systemusers[$data_info['jsondata'][1]['FromUid']]:''}</p>
      </dd>
      <dd>
        <h1>状态</h1>
        <p>{$data_info['status_info']}</p>
      </dd>
      <dd>
        <h1>问题类型</h1>
        <p>{$params['op_order_type'][$data_info['op_order_type']]}</p>
      </dd>
    </dl>
    <dl class="clearfix">
      <dt><i class="layui-icon layui-icon-username"></i>用户信息</dt>
      <dd>
        <h1>姓名</h1>
        <p>{$data_info['nick']}</p> 
      </dd>
      <dd>
        <h1>管段</h1>
        <p>{$params['insts'][$data_info['inst_id']]}</p> 
      </dd>
    </dl>
  </div>
</div>
</div>

<style>
  .j-frame-class{padding: 15px 15px 0;}
  .j-frame-class .j-frame-label{ font-size: 16px; color:rgba(74,74,74,1); line-height: 40px; margin-bottom: 10px;}
  .layui-layer-title{font-size: 16px; font-weight: bold;}
  .j-frame-class .layui-form-select dl dd.layui-this{background-color:#0084FF;}
  .j-frame-class .layui-form-select dl dt{ font-size: 14px;}
</style>
<div class="row j-frame-class" style="display:none" id="show_div">
  <form class="layui-form" >
    <div class="layui-form-item">
      <label class="j-frame-label">工单受理人</label>
      <div class="j-input-block">
        <select name="transfer_to" id="transfer_to">
          <option value="">请选择工单受理人</option>
          {if condition="ADMIN_ROLE != 10"}
          <optgroup label="技术部">
            <option value="41" {if condition="session('admin_user.nick') == '卢金权'"}disabled{/if}>卢金权</option>
          </optgroup>
          {/if}
          {if condition="ADMIN_ROLE != 9"}
          <optgroup label="经管科">
            <option value="42" {if condition="session('admin_user.nick') == '叶慧丽'"}disabled{/if}>叶慧丽</option>
          </optgroup>
          {/if}
          {if condition="ADMIN_ROLE != 11"}
          <optgroup label="运营部">
            <option value="39" {if condition="session('admin_user.nick') == '郑湾'"}disabled{/if}>郑湾</option>
            <option value="40" {if condition="session('admin_user.nick') == '刘丹'"}disabled{/if}>刘丹</option>
          </optgroup>
          {/if}
        </select>
      </div>
    </div>
      </form>
    </div>
    {include file="system@block/layui" /}
    <script src="__PUBLIC_JS__/jquery.2.1.4.min.js?v={:config('hisiphp.version')}"></script>
    <script>
      layui.use(['form', 'func'], function() {
        var $ = layui.jquery, form = layui.form;

        //转交工单
        $("#handover").on("click",function(){
          layer.open({
            type: 1,
            btn: ["确定","取消"],
            zIndex: 10,
            title: ['转交工单'],
            area: ['400px','500px'],
            offset: 'auto',
            content: $('#show_div'),
            yes: function(index, layero){
              console.log($('.layui-form').serialize());
              var data = $('.layui-form').serialize();
            // var data = data + '&transfer_to=' + transfer_to;
            formSubmit('post',"{:url('transfer')}",data,index);
          }
        });

        })
        function formSubmit(type,url,data,index){
          $.ajax({
            type: type,
            url: url,
            data: data,
            success: function(res) {
              console.log(res);
              layer.msg(res.msg, {
                isOutAnim:false,
              },function(){
                if (res.code != 0){
                  location.href = res.url;
                }
              });
            }
          });
          return false;
        }
    //完结工单
    $("#complete").on("click", function() {
      layer.confirm("是否确认完结工单", {
        btn: ["确定","取消"],
        icon: 3,
        title:false,
        offset: 'auto',
        closeBtn:false
      }, function(index){
        console.log($('.layui-form').serialize());
        var data = $('.layui-form').serialize();
        var data = data + '&is_end=' + 1;
        formSubmit('post',"{:url('transfer')}",data,index);
      }, function(index){
        layer.close(index);
      });
    });
  });
  </script>
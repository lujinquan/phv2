<div class="j-table-content j-no-title j-reportform">
	<div class="page-toolbar j-page-toolbar clearfix">
	      <form class="layui-form layui-form-pane" >
			<div class="j-search-fl layui-col-md6  fl">
	            {if condition="INST_LEVEL != 3"}
				<div class="layui-input-inline" style="width:140px;">
					<select name="inst_id">
					  <option value="">机构</option>
					  {volist name=":config('inst_check_names')[INST]" id="v"}
					  <option value="{$key}"{if condition="$key == $Think.INST"}selected{/if}>{$v}</option>
					  {/volist}
					</select>
				</div>
				{/if}
	          <div class="layui-input-inline" style="width:120px;padding-left:5px">
	              <select name="owner_id" lay-filter="owner_id">
	                  <option value="">产别</option>
	                  {volist name="params['owners']" id="v"}
	                  <option value="{$key}" {if condition="$key == 1"}selected{/if}>{$v}</option>
	                  {/volist}
	              </select>
	          </div>
	          <div class="layui-input-inline" style="width:120px;padding-left:5px">
	              <select name="use_id" lay-filter="owner_id">
	                  <option value="">使用性质</option>
	                  {volist name="params['uses']" id="v"}
	                  <option value="{$key}" {if condition="$key == 1"}selected{/if}>{$v}</option>
	                  {/volist}
	              </select>
	          </div>
	          <div class="layui-input-inline" style="width:120px;padding-left:5px">
	              <input type="text" name="query_month" value="" placeholder="月份" id="timeYear" autocomplete="off" class="layui-input">
	          </div>
	        </div>
			
	        <div class="j-search-fr layui-col-md6 fr">
	          <div class="layui-input-inline fr">
				<button type="reset" class="layui-btn j-btn-reset">重置</button>
				<button type="button" class="layui-btn"  id="button_search" lay-submit lay-filter="formDemo">
				    <i class="layui-icon">&#xe615;</i>
				    搜索
				</button>
				<button type="button" class="layui-btn layui-btn-warm on" id="button_print">
				    <i class="layui-icon layui-icon-print"></i>
				    导出
				</button>
	          </div>
			</div>
	      </form>
	  </div>
	   <!--startprint1-->
	  <div class="j-report-con">
		  <h1 class="j-report-title">欠租明细统计（<span id="DOwnerTyp">市属</span>）报表</h1>
		  <div class="j-report-table">
			  <!-- <ul>
				  <li><div class=" DQueryType j-bold-size">产别：</div></li>
				  <li><div class="time j-bold-size"></div></li>
				  <li><div class="fontsize j-bold-size">单位：建筑面积：平方米 规定租金：元</div></li>
			  </ul> -->
			  <table class="layui-table" id="PropertyForm">
			          <!-- 完损等级分 -->
			          <tbody id="Tbody">
			              
			          </tbody>
					  <tfoot id="Statistics">
						<tr>
							<td>统计</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td id="j-month">0</td>
							<td id="j-previous-months"></td>
							<td id="j-previous-year"></td>
							<td id="j-sum"></td>
							<td>&nbsp;</td>
						</tr>   
					  </tfoot>
			  </table>
		  </div>
	  </div>
	   <!--endprint1-->
</div>
{include file="system@block/layui" /}
<table id="dataTable" lay-filter='dataTable'></table>
<script type="text/javascript" src="__ADMIN_VIEWJS__/report_house_archives.js?v={:config('hisiphp.version')}"></script>
<script>
    layui.use(['jquery', 'laydate', 'element','table'], function(){
        var laydate = layui.laydate,
		    $ = layui.$
			,element = layui.element
			,table = layui.table;
		function statistics(){
		    var trList = $("#Tbody").children("tr");
			var j_month =0,
			    j_previous_months=0,
				j_previous_year=0,
				j_sum =0;
			$("#j-month").text();
			$("#j-previous-months").text();	
			$("#j-previous-year").text();
			for (var j=2;j<trList.length;j++) {
				var tdArr = trList.eq(j).find("td"); //遍历td  
					j_month += parseFloat(tdArr.eq(4).text()).toFixed(2)*100;//房屋欠租情况本月份
					$("#j-month").text(j_month.toFixed(2) / 100);
				    j_previous_months += parseFloat(tdArr.eq(5).text()).toFixed(2)*100;//房屋欠租情况以前月份
					$("#j-previous-months").text(j_previous_months.toFixed(2)/100);
					j_previous_year += parseFloat(tdArr.eq(6).text()).toFixed(2)*100;//房屋欠租情况以前年
					$("#j-previous-year").text(j_previous_year.toFixed(2)/100);
					j_sum += parseFloat(tdArr.eq(7).text()).toFixed(2)*100;//房屋欠租情况总和
					$("#j-sum").text(j_sum.toFixed(2)/100);
			}
		}
		
		$("#button_search").click(function(){
			var inst = $("select[name='inst_id']").val();
			var owner = $("select[name='owner_id']").val();
			var use = $("select[name='use_id']").val();
			var month = $("input[name='query_month']").val();
			$.ajax({
				type:"post",// 请求方式
				url:"{:url('rent/unpaidRent')}",
				async:true,// 同步异步
				dataType:"json",
				data :{'inst_id':inst,'owner_id':owner,'use_id':use,'query_month':month},//这里是前台传到后台的数据
			    //回调函数
				success:function(jsondata){

					var tableStr = `<tr>
						  <th rowspan="2" colspan="1" class="j-bold-size">房屋编号</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">地址</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">户名</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">使用性质</th>
		                  <th rowspan="1" colspan="4" class="j-bold-size">房屋欠租情况</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">备注</th>
		                </tr>
		                <tr>
		                  <td rowspan="1" colspan="1" >本月份</td>
		                  <td rowspan="1" colspan="1" >以前月份</td>
		                  <td rowspan="1" colspan="1" >以前年度</td>
		                  <td rowspan="1" colspan="1" >合计</td>
		                </tr>`;

					var data = jsondata.data;//由JSON字符串转换为JSON对象
					console.log(data);
					//var str = '';
					for(var i in data) {
						tableStr += "<tr><td>" + data[i].number + "</td><td>" + data[i].address + "</td><td>" + data[i].tenant + "</td><td>" + data[i].use + "</td><td>"+ data[i].curMonthUnpaidRent + "</td><td>" +data[i].beforeMonthUnpaidRent+ "</td><td>" +data[i].beforeYearUnpaidRent+ "</td><td>" +data[i].total+ "</td><td>" + data[i].remark+"</td></tr>";
						
					}
					//console.log(tableStr);
					$('#Tbody').html(tableStr);
					statistics();
				}
			})
		});
		// 写入数据
		$.ajax({
			type:"post",// 请求方式
			url:"{:url('rent/unpaidRent')}",
			async:true,// 同步异步
			dataType:"json",
			//data :{'inst_id':inst,'owner_id':owner,'query_month':month},//这里是前台传到后台的数据
		    //回调函数
			success:function(jsondata){
				var data = jsondata.data;//由JSON字符串转换为JSON对象
				
				var str = `<tr>
						  <th rowspan="2" colspan="1" class="j-bold-size">房屋编号</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">地址</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">户名</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">使用性质</th>
		                  <th rowspan="1" colspan="4" class="j-bold-size">房屋欠租情况</th>
		                  <th rowspan="2" colspan="1" class="j-bold-size">备注</th>
		                </tr>
		                <tr>
		                  <td rowspan="1" colspan="1" >本月份</td>
		                  <td rowspan="1" colspan="1" >以前月份</td>
		                  <td rowspan="1" colspan="1" >以前年度</td>
		                  <td rowspan="1" colspan="1" >合计</td>
		                </tr>`;
				
				for(var i in data) {
					//console.log(data[i].address);
					// tableStr += "<tr>\
					// 				<td rowspan='1' colspan='1'>1</td>\
					// 				<td rowspan='1' colspan='1'>2</td>\
					// 				<td rowspan='1' colspan='1'>3</td>\
					// 				<td rowspan='1' colspan='1'>4</td>\
					// 				<td rowspan='1' colspan='1'>5</td>\
					// 				<td rowspan='1' colspan='1'>6</td>\
					// 				<td rowspan='1' colspan='1'>7</td>\
					// 				<td rowspan='1' colspan='1'>8</td>\
					// 			</tr>";
					str += "<tr><td>" + data[i].number + "</td><td>" + data[i].address + "</td><td>" + data[i].tenant + "</td><td>" + data[i].use + "</td><td>"+ data[i].curMonthUnpaidRent + "</td><td>" + data[i].beforeMonthUnpaidRent + "</td><td>" +data[i].beforeYearUnpaidRent+ "</td><td>" +data[i].total+ "</td><td>" + data[i].remark+"</td></tr>";
					
				}
				//console.log(tableStr);
				$('#Tbody').html(str);
				statistics();
			}
		})
        

        //年选择器
        laydate.render({
            elem: '#timeYear'
            ,type: 'month'
			,value: new Date() 
            ,isInitValue: true,
			ready: function(date){
			    $('.layui-laydate li').click(function () {
			       $('.laydate-btns-confirm').trigger('click');
			    });
			}
        });

        $('#button_print').click(function(){
        	var inst = $("select[name='inst_id']").val();
			var owner = $("select[name='owner_id']").val();
			var use = $("select[name='use_id']").val();
			var month = $("input[name='query_month']").val();
        	$.ajax({
				type:"post",// 请求方式
				url:"{:url('rent/export')}",
				async:true,// 同步异步
				dataType:"json",
				data :{'inst_id':inst,'owner_id':owner,'query_month':month},//这里是前台传到后台的数据
			    //回调函数
				success:function(output){
					layer.msg(output.msg);
					if(output.code){ //成功则直接下载						
						document.location.href = output.data;
					}
					//console.log(output);
				}
			});
        })

        
		
		
    });
	
</script>
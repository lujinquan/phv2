<!-- 欠租明细表 -->
<style>
	.j-table-content.j-no-title{min-height: 300px;}
</style>
<!-- 新增后台导出按钮 -->
<link rel="stylesheet" href="__ADMIN_JS__/select/formSelects-v4.css">
<button id="button_prints"><i class="layui-icon layui-icon-export"></i></button>
<div class="j-table-content j-no-title j-reportform">
	<div class="page-toolbar j-page-toolbar clearfix">
	      <form class="layui-form layui-form-pane" id="report-form">
			<div class="j-search-fl layui-col-md6  fl">
	            {if condition="INST_LEVEL != 3"}
				<div class="layui-input-inline" style="width:140px;">
					<select name="inst_id">
					  {volist name=":config('inst_check_names')[INST]" id="v"}
					  <option value="{$key}"{if condition="$key == $Think.INST"}selected{/if}>{$v}</option>
					  {/volist}
					</select>
				</div>
				{/if}
	          <div class="layui-input-inline  j-width-90 j-margin-10">
					<select name="owner_id" xm-select="ban_owner_id">
						<option value="" disabled="disabled">产别</option>
						{volist name="params['owners']" id="v"}
						<option value="{$key}">{$v}</option>
						{/volist}
					</select>
				</div>
	          <div class="layui-input-inline  j-width-115 j-margin-10">
					<select name="use_id" xm-select="house_use_id">
						<option value="" disabled="disabled">使用性质</option>
						{volist name="params['uses']" id="v"}
						<option value="{$key}">{$v}</option>
						{/volist}
					</select>
				</div>
	          <div class="layui-input-inline" style="width:120px;padding-left:5px">
	              <input type="text" name="query_month" value="{:date('Y-m')}" readonly placeholder="月份" id="timeYear" autocomplete="off" class="layui-input">
	          </div>
	        </div>
			
	        <div class="j-search-fr layui-col-md6 fr">
	          <div class="layui-input-inline fr">
				<button type="reset" class="layui-btn j-btn-reset">重置</button>
				<button type="button" class="layui-btn"  id="button_search" lay-submit lay-filter="formDemo">
				    <i class="layui-icon">&#xe615;</i>
				    搜索
				</button>
				{if condition="in_array(340,$auths) || $Think.ADMIN_ROLE == 1"}
				<button type="button" class="layui-btn layui-bg-green on" id="button_create">
				    <i class="layui-icon layui-icon-chart"></i>
				    生成本月报表
				</button>
				{/if}
				<!-- <button type="button" class="layui-btn layui-btn-warm on" id="button_print">
				    <i class="layui-icon layui-icon-print"></i>
				    导出
				</button> -->
	          </div>
			</div>
	      </form>
	  </div>
	   <!--startprint1-->
	  <div class="j-report-con">
		  <h1 class="j-report-title">欠租明细统计<!-- （<span id="DOwnerTyp">市属</span>） -->报表</h1>
		  <div class="j-report-table">
			  <!-- <ul>
				  <li><div class=" DQueryType j-bold-size">产别：</div></li>
				  <li><div class="time j-bold-size"></div></li>
				  <li><div class="fontsize j-bold-size">单位：建筑面积：平方米 规定租金：元</div></li>
			  </ul> -->
			  <table class="layui-table" id="PropertyForm" style="position: relative;">
			          <!-- 完损等级分 -->
					  <thead style="background-color: #f2f2f2;position: absolute;top: 0px;width: 100%;display: inherit;">
						 <tr>
						 	  <th rowspan="2" colspan="1" class="j-bold-size" style="width: 10%;">房屋编号</th>
						       <th rowspan="2" colspan="1" class="j-bold-size" style="width: 10%;">地址</th>
						       <th rowspan="2" colspan="1" class="j-bold-size" style="width: 10%;">户名</th>
						       <th rowspan="2" colspan="1" class="j-bold-size" style="width: 10%;">使用性质</th>
						       <th rowspan="1" colspan="4" class="j-bold-size" style="width: 50%;">房屋欠租情况</th>
						       <th rowspan="2" colspan="1" class="j-bold-size" style="width: 10%;">备注</th>
							   <th rowspan="2" colspan="1" class="j-bold-sizes" style="padding-right:8px!important;box-sizing: border-box;"></th>
						     </tr>
						     <tr>
						       <td rowspan="1" colspan="1" style="width: 10%;">本月份</td>
						       <td rowspan="1" colspan="1" style="width: 10%;">以前月份</td>
						       <td rowspan="1" colspan="1" style="width: 10%;">以前年度</td>
						       <td rowspan="1" colspan="1" style="width: 20%;">合计</td>
						     </tr>  
					  </thead>
			          <tbody id="Tbody" class="j-PropertyForm" style="width: 100%; display: table-caption;overflow-y: auto;max-height:400px;margin-top:75px ;">
			             
			          </tbody>
					  <tfoot id="Statistics">
						<tr>
							<td style="width: 10%;">统计</td>
							<td id="j-heji" style="width: 10%;">&nbsp;</td>
							<td style="width: 10%;">&nbsp;</td>
							<td style="width: 10%;">&nbsp;</td>
							<td id="j-month" style="width: 10%;"></td>
							<td id="j-previous-months" style="width: 10%;"></td>
							<td id="j-previous-year" style="width: 10%;"></td>
							<td id="j-sum" style="width: 20%;"></td>
							<td style="width: 10%;">&nbsp;</td>
							<td class="j-bold-sizes" style="padding-right:8px!important;box-sizing: border-box;"></td>
							
						</tr>   
					  </tfoot>
			  </table>
		  </div>
	  </div>
	   <!--endprint1-->
</div>
{include file="system@block/layui" /}
<table id="dataTable" lay-filter='dataTable'></table>
<!-- <script type="text/javascript" src="__ADMIN_VIEWJS__/report_house_archives.js?v={:config('hisiphp.version')}"></script> -->
<script>
    layui.use(['jquery', 'laydate', 'element','table','formSelects'], function(){
        var laydate = layui.laydate,
		    $ = layui.$
			,element = layui.element
			,table = layui.table
			,formSelects = layui.formSelects;
		$("#button_search").click(function(){
			var queryWhere = $('#report-form').serialize();
			//console.log('生成报表后查询的条件：',queryWhere);

			// var inst = $("select[name='inst_id']").val();
			// var owner = $("select[name='owner_id']").val();
			// var use = $("select[name='use_id']").val();
			// var month = $("input[name='query_month']").val();
			$("#j-month").text();
			$("#j-previous-months").text();	
			$("#j-previous-year").text();
			$("#j-sum").text();
			$.ajax({
				type:"post",// 请求方式
				url:"{:url('rent/unpaidRent')}",
				async:true,// 同步异步
				dataType:"json",
				//data :{'inst_id':inst,'owner_id':owner,'use_id':use,'query_month':month},//这里是前台传到后台的数据
				data : queryWhere,//这里是前台传到后台的数据
			    //回调函数
				success:function(jsondata){
                    console.log("打印搜索数据:",jsondata);
					var tableStr = ``;

					var data = jsondata.data;//由JSON字符串转换为JSON对象
					var k = 0;
					for(var i in data) {
						tableStr += "<tr><td style='width: 10%;'>" + data[i].number + "</td><td style='width: 10%;'>" + data[i].address + "</td><td style='width: 10%;'>" + data[i].tenant + "</td><td style='width: 10%;'>" + data[i].use + "</td><td style='width: 10%;'>"+ data[i].curMonthUnpaidRent + "</td><td style='width: 10%;'>" +data[i].beforeMonthUnpaidRent+ "</td><td style='width: 10%;'>" +data[i].beforeYearUnpaidRent+ "</td><td style='width: 20%;'>" +data[i].total+ "</td><td style='width: 10%;'>" + data[i].remark+"</td></tr>";
						k++;
					}
					$('#j-heji').text('总数：'+k+'条');
					if(k>11){
						$(".j-bold-sizes").show();
					}
					else{
						$(".j-bold-sizes").hide();
					}
					//console.log(tableStr);
					$('#Tbody').html(tableStr);
					
					$("#j-month").text(jsondata.total_cur_month_unpaid_rent);
					$("#j-previous-months").text(jsondata.total_before_month_unpaid_rent);	
					$("#j-previous-year").text(jsondata.total_before_year_unpaid_rent);
					$("#j-sum").text(jsondata.total_unpaid_rent);
					
				}
			})
		});
		$('#button_create').click(function(){
			var that = $(this);
			that.prop('disabled', true);
			that.addClass('layui-btn-disabled').removeClass('layui-bg-green').text('生成中……');

			$.post('{:url('rent/makeUnpaidReport')}', function(res) {
                layer.msg(res.msg, {time:3000},function(){

                	that.prop('disabled', false);
					that.removeClass('layui-btn-disabled').addClass('layui-bg-green').html('<i class="layui-icon layui-icon-chart"></i>生成本月报表');	

                	var queryWhere = $('#report-form').serialize();
					console.log('生成报表后查询的条件：',queryWhere);
                	$.ajax({
						type:"post",// 请求方式
						url:"{:url('rent/unpaidRent')}",
						async:true,// 同步异步
						dataType:"json",
						data :queryWhere,
					    // 回调函数
						success:function(result){
							var data = JSON.parse(result).data;//由JSON字符串转换为JSON对象
							console.log('生成报表后查询成功！');
							if(data.length==0)
							{
								$('tbody').html("<div class='j-no-contents'><i class='layui-icon iconfont j-icon-wushuju'></i>暂无数据！</div>");
							}
							else{
								var trData = datajson(data);
								$('tbody').html(trData);
							}
			                
							//将值为0.00的替换为空
							$(".report tr").each(function(){
							        var td=$(this).find("td");
							        td.each(function(){
							            if($(this).text()=="0.00" || $(this).text()==0){
							                $(this).text("");
							            }
							        });
							});
							
						},
					  //返回错误
						error:function(xhr){
			              console.log(xhr.msg)
						}
					});
                	//location.reload();
                });
                
            });
		})
		// 写入数据
		$.ajax({
			type:"post",// 请求方式
			url:"{:url('rent/unpaidRent')}",
			async:true,// 同步异步
			dataType:"json",
			//data :{'inst_id':inst,'owner_id':owner,'query_month':month},//这里是前台传到后台的数据
		    //回调函数
			success:function(jsondata){
				console.log("欠租明细数据:",jsondata);
				var data = jsondata.data;//由JSON字符串转换为JSON对象

				var str = ``;
				var k = 0;
				for(var i in data) {
					//console.log(data[i].address);
					// tableStr += "<tr>\
					// 				<td rowspan='1' colspan='1'>1</td>\
					// 				<td rowspan='1' colspan='1'>2</td>\
					// 				<td rowspan='1' colspan='1'>3</td>\
					// 				<td rowspan='1' colspan='1'>4</td>\
					// 				<td rowspan='1' colspan='1'>5</td>\
					// 				<td rowspan='1' colspan='1'>6</td>\
					// 				<td rowspan='1' colspan='1'>7</td>\
					// 				<td rowspan='1' colspan='1'>8</td>\
					// 			</tr>";
					str += "<tr><td style='width: 10%;'>" + data[i].number + "</td><td style='width: 10%;'>" + data[i].address + "</td><td style='width: 10%;'>" + data[i].tenant + "</td><td style='width: 10%;'>" + data[i].use + "</td><td style='width: 10%;'>"+ data[i].curMonthUnpaidRent + "</td><td style='width: 10%;'>" + data[i].beforeMonthUnpaidRent + "</td><td style='width: 10%;'>" +data[i].beforeYearUnpaidRent+ "</td><td style='width: 20%;'>" +data[i].total+ "</td><td style='width: 10%;'>" + data[i].remark+"</td></tr>";
					k++;
				}
				
				$('#j-heji').text('总数：'+k+'条');
			    if(k>11){
			    	$(".j-bold-sizes").show();
			    }
			    else{
			    	$(".j-bold-sizes").hide();
			    }
				$('#Tbody').html(str);
				$("#j-month").text(jsondata.total_cur_month_unpaid_rent);
				$("#j-previous-months").text(jsondata.total_before_month_unpaid_rent);	
				$("#j-previous-year").text(jsondata.total_before_year_unpaid_rent);
				$("#j-sum").text(jsondata.total_unpaid_rent);
			}
		})
        

        //年选择器
        laydate.render({
            elem: '#timeYear'
            ,type: 'month'
            ,btns: ['now', 'confirm']
			//,value: new Date() 
			,min: '2020-6-1'
            ,isInitValue: true,
			ready: function(date){
			    $('.layui-laydate li').click(function () {
			       $('.laydate-btns-confirm').trigger('click');
			    });
			}
        });

        $('#button_prints').click(function(){
        	var queryWhere = $('#report-form').serialize();
			console.log('导出的条件：',queryWhere);
			$('#button_prints').prop('disabled', true).removeClass('layui-btn-warm').addClass('layui-bg-gray').text('导出中…');
        	$.ajax({
				type:"post",// 请求方式
				url:"{:url('rent/export')}",
				async:true,// 同步异步
				dataType:"json",
				data :queryWhere,//这里是前台传到后台的数据
			    //回调函数
				success:function(output){
					layer.msg(output.msg);
					if(output.code){ //成功则直接下载		
						$('#button_prints').prop('disabled', false).removeClass('layui-bg-gray').addClass('layui-btn-warm').html('<i class="layui-icon layui-icon-export"></i>');			
						document.location.href = output.data;
					}
					else{
						$('#button_prints').prop('disabled', false).removeClass('layui-bg-gray').addClass('layui-btn-warm').html('<i class="layui-icon layui-icon-export"></i>');  
					}
				}
			});
        })
    });
	
</script>
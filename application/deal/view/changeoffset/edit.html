<link rel="stylesheet" href="__PUBLIC_JS__/viewer/viewer.min.css?v={:config('hisiphp.version')}">
<form class="layui-form" action="" method="post" >
  <div class="j-details-box j-table-content floorWrap">
	<fieldset class="layui-elem-field layui-field-title j-field-box">
		<legend>基本信息</legend>
	</fieldset>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md8">
			<label class="j-form-label"><i class="red">*</i>房屋编号</label>
			<div class="j-input-inline j-tips">
				<input type="text" id="house_number" name="house_number" lay-verify="required" readonly value="{$data_info['house_info']['house_number']}" placeholder="点击查询" autocomplete="off" class="layui-input">
				<input type="hidden" name="id" value="{$data_info['id']}">
				<input type="hidden" id="ban_id" name="ban_id" value="{$data_info['ban_info']['ban_id']}">
				<input type="hidden" id="house_id" name="house_id" value="{$data_info['house_id']}">
				<input type="hidden" id="tenant_id" name="tenant_id" value="{$data_info['tenant_id']}">
				<input type="hidden" id="rent_order_date" name="rent_order_date" value="{$data_info['rent_order_date']}">
				<input type="hidden" id="before_year_copy" name="before_year_rent" value="{$data_info['before_year_rent']}">
				<input type="hidden" id="before_month_copy" name="before_month_rent" value="{$data_info['before_month_rent']}">
				<input type="hidden" id="this_month_copy" name="this_month_rent" value="{$data_info['this_month_rent']}">
				<b class="j-explain-search j-house_number">查询</b>
			</div>
			<div class="layui-form-mid layui-word-aux j-size-class"><i class="layui-icon layui-icon-tips"></i>可以核销当月订单</div>
		</div>
		<div class="layui-col-md4">
			<label class="j-form-label">异动编号</label>
			<div class="j-input-inline">
				<input type="text" name="change_order_number" value="{$data_info['change_order_number']}" autocomplete="off" class="layui-input" readonly>
			</div>
		</div>
	</div>
		<table  class="layui-table">
		  <thead>
			  <tr>
			    <th>房屋编号</th>
			    <th>楼栋地址</th>
			    <th>机构</th>
			    <th>产别</th>
			    <th>使用性质</th>
			    <th>租户姓名</th>
			    <th>规定租金</th>
			  </tr>
		  </thead>
		  <tbody>
		    <tr>
		  	  <td id="house_numbers">&nbsp;{$data_info['house_info']['house_number']}</td>
			  <td id="building_address">&nbsp;{$data_info['ban_info']['ban_address']}</td>
			  <td id="mechanism">&nbsp;{$params['insts'][$data_info['ban_info']['ban_inst_id']]}</td>
	    	  <td id="yield_differentiation">&nbsp;{$params['owners'][$data_info['ban_info']['ban_owner_id']]}</td>
	    	  <td id="nature_usage">&nbsp;{$params['uses'][$data_info['house_info']['house_use_id']]}</td>
	    	  <td id="tenant_name">&nbsp;{$data_info['tenant_info']['tenant_name']}</td>
			  <td id="prescribed_rent">&nbsp;{$data_info['house_info']['house_pre_rent']}</td>
		    </tr>
		  </tbody>
		</table>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md8">
			<label class="j-form-label">异动原因</label>
			<div class="j-input-inline">
				<input type="text" id="tenant_reason" name="change_remark" value="{$data_info['change_remark']}" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>
	<fieldset id="item1" class="layui-elem-field layui-field-title j-field-box">
		<legend>异动信息</legend>
	</fieldset>
	<table  class="layui-table j-house-box">
	  <thead>
		  <tr>
		    <th>核销类型</th>
		    <th>以前年</th>
		    <th>以前月</th>
		    <th>本月</th>
		    <th>总金额</th>
		  </tr>
	  </thead>
	 <tbody>
	   <tr>
	 	  <td id="write_type">金额</td>
		  <td id="before_year">{$data_info['before_year_rent']}</td>
		  <td id="before_month">{$data_info['before_month_rent']}</td>
		  <td id="this_month">{$data_info['this_month_rent']}</td>
		  <td id="total_sum">{:array_sum([$data_info['before_year_rent'],$data_info['before_month_rent'],$data_info['this_month_rent']])}</td>
	   </tr>
	 </tbody>
	</table>
	<fieldset id="item1" class="layui-elem-field layui-field-title j-field-box">
		<legend>明细信息</legend>
	</fieldset>
	<table id="dataTable" class="layui-table default-tables" lay-filter='dataTable'>
		  <thead>
    <tr>
      <th>订单编号</th>
      <th>产别</th>
      <th>使用性质</th>
      <th>账单金额</th>
      <th>已支付金额</th>
      <th>账单期</th>
      <th>地址</th>
      <th>租户姓名</th>
    </tr> 
  </thead>
  <tbody>
  	{volist name="$data_info['data_json']" id="v"}
    <tr>
      <td>{$v['rent_order_number']}</td>
      <td>{$params.owners[$v['ban_owner_id']]}</td>
      <td>{$params.uses[$v['house_use_id']]}</td>
      <td>{$v['rent_order_receive']}</td>
      <td>{$v['rent_order_paid']}</td>
      <td>{$v['rent_order_date']}</td>
      <td>{$v['ban_address']}</td>
      <td>{$v['tenant_name']}</td>
    </tr>
    {/volist}
  </tbody>
	</table>
	<fieldset id="item1" class="layui-elem-field layui-field-title j-field-box">
		<legend>填报信息</legend>
	</fieldset>
    
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md12">
			<div class="j-enclosure-upload clearfix">
				<div class="j-enclosure-label">{if condition="in_array('HouseForm',$config['changeoffset_file_upload'])"}<i class="red">*</i>{/if} 其他</div>
				<div class="j-enclosure-label j-uplode-icon">
					<i><img src="/static/system/image/Group8.png"></i>点击上传
					<button type="button" class="layui-btn layui-btn-primary" id="upload_img2">上传图片</button>
				</div>
				<div class="layui-form-mid layui-word-aux">限制5M</div>
			</div>
			<div class="j-enclosure-imgs clearfix">
	   				<div id="upload_img_list2" class="upload_img_list j-viewer-img">
	   					{volist name="$data_info['change_imgs']" id="v"}
						{if condition="$v['file_type'] == 'HouseForm'"}
						<dd class="item_img" id="">
							<div class="operate">
								<i  class="layui-icon-close-fill layui-icon"></i>
							</div>
							<img src="{$v['file']}" class="img" ><input type="hidden" name="HouseForm[]" value="{$v['id']}" />
						</dd>
						{/if}
						{/volist}
	   				</div>
	   			</div>
		</div>
		<div class="layui-upload">
		</div>
	</div>
	{include file="common/submit"}

  </div>
</form>
{include file="system@block/layui" /}
<!-- 图片查看 -->
<link rel="stylesheet" href="__PUBLIC_JS__/viewer/viewer.min.css?v={:config('hisiphp.version')}">
<script type="text/javascript" src="__PUBLIC_JS__/viewer/viewer-jquery.min.js?v={:config('hisiphp.version')}"></script>
<script type="text/javascript">
	var upurl = "{:url('system/Api/upload')}?input=TenantReIDCard&group=change&water=no"; //身份证信息
	var upurl1 = "{:url('system/Api/upload')}?input=HouseForm&group=change&water=no"; //租约
	var upurl2 = "{:url('system/Api/upload')}?input=ChangeOffsetUpload&group=change&water=no"; //报告
	var duotu = true; //是否为多图上传true false
	layui.use(['jquery', 'laydate', 'upload', 'form','table'], function() {
		var table = layui.table
		    ,form = layui.form
			,$ = layui.jquery
			,upload = layui.upload
			,layer = layui.layer;
		//获取房屋查询器
		 $(".layui-form").on('click','.j-house_number',function(){
			layer.open({
					title: '房屋查询器'
					,type: 2
					,offset: 'auto'
					,area: ['70%', '60%']
					, btn:false
					,pageTabs: false
					,content: '{:url('system/index/house')}?hisi_iframe=yes&change_type=4'
					,btn: ['确定','关闭']
					,yes: function(index, layero){
						var row = window["layui-layer-iframe" + index].hoesedata();
						if(row.color_status != 1){ //正常状态下的才可以执行
						    layer.msg("当前数据不可选！");
							return false;
						}
						layer.close(index);
						var hosue_number = row.house_number;
						$("#house_number").val(row.house_number);//获取房屋编号
						$("#house_id").val(row.house_id);//获取房屋id
						$("#ban_id").val(row.ban_id);//获取楼栋id
						$("#tenant_id").val(row.tenant_id);//获取租户id
						$("#house_number").val(row.house_number);//获取房屋编号
						$("#house_numbers").text(row.house_number);//获取房屋编号
						$("#building_address").text(row.ban_address);//获取楼栋地址
						$("#mechanism").text(params.insts[row.ban_inst_id]);//获取机构
						$("#yield_differentiation").text(params.owners[row.ban_owner_id]);//获取产别
						$("#nature_usage").text(params.uses[row.house_use_id]);//获取使用性质
						$("#tenant_name").text(row.tenant_name);//获取租户姓名
						$("#prescribed_rent").text(row.house_pre_rent);//获取规定租金
						$('.default-tables').hide();
						table.render({
						    elem: '#dataTable'
						    //,height: 550
							,toolbar: '#toolbar'
							,defaultToolbar: ['filter','exports','print'] //设置右边筛选，导出，打印显示
						    ,url: '{:url("rent/Unpaid/index")}?house_number='+row.house_number
						    ,page: false 
						    ,limit: 100
						    ,text: {
						        none : "<div class='j-no-contents'><i class='layui-icon iconfont j-icon-wushuju'></i>暂无相关数据！</div>"
						    }
						    ,cols: [[ //表头
						        {type: 'checkbox', fixed: 'left'}
						        ,{field: 'rent_order_number',minWidth: 200, align:'center', title: '订单编号'}
						        ,{field: 'ban_inst_id', minWidth: 120, hide:isShowInst, align:'center', title: '管段', templet: function(d) {
						            return params.insts[d.ban_inst_id];
						        }}
						        ,{field: 'ban_owner_id', minWidth: 80, align:'center', title: '产别', templet: function(d) {
						            return params.owners[d.ban_owner_id];
						        }}
						        ,{field: 'house_use_id', minWidth: 100, align:'center', title: '使用性质', templet: function(d) {
						            return params.uses[d.house_use_id];
						        }}
						        ,{field: 'rent_order_receive', minWidth: 140, align:'center', title: '账单金额'}
						        ,{field: 'rent_order_paid', minWidth: 140, align:'center', title: '已支付金额'}
						        ,{field: 'rent_order_unpaid', minWidth: 140, align:'center', title: '欠缴金额'}
						        ,{field: 'rent_order_date', minWidth: 140, align:'center', title: '账单期'}
						        ,{field: 'ban_address', minWidth: 140, align:'center', title: '地址'}
						        ,{field: 'tenant_name', minWidth: 140, align:'center', title: '租户姓名'}
						        //,{title: '操作', minWidth: 260,Width: 260,align:'center', templet: '#buttonTpl',fixed:'right'}
						    ]]
						    ,done:function(res,curr,count){
						       
						    }
						},isShowInst,house_number)
						$("#before_year").text(0);
						$("#before_month").text(0);
						$("#this_month").text(0);
						$("#total_sum").text(0);
					},btn2: function(index, layero){
						layer.close(index);
					}
			 });
		})	
		//获取选中的table数据
		  table.on('checkbox(dataTable)', function(obj){
                var checkStatus = table.checkStatus('dataTable');
                var data = checkStatus.data;
                var previousmonths = 0; //以前年
				var previousmonths1 = 0;//以前月
				var previousmonths2 = 0;//本月
				var previousmonths3 = 0;//总金额
				var myDate = new Date;
				console.log(data);
				var years = myDate.getFullYear(),//获取当前年
				    months = ("0" + (myDate.getMonth() + 1)).slice(-2),//获取当前月
					jdates = years+''+months;
				var monthdatas = [];//选中的以前月
				var yeardatas = [];//选中的以前年
				var thismonth = [];//选中本月
			    // console.log(jdates);
                //console.log(data);
                //console.log(obj.data.rent_order_unpaid);
				//console.log(previousmonths3 );
				if(data.length<=0)
				{
					$("#before_year").text(0);
					$("#before_month").text(0);
					$("#this_month").text(0);
					$("#total_sum").text(0);
					
				}
				var rent_order_date = '';
				for(var i=0;i<data.length;i++) {
					//判断本月
					if(data[i].rent_order_date==jdates){
						thismonth.push(data[i].rent_order_unpaid);
						previousmonths2 += parseFloat(data[i].rent_order_unpaid) * 100;
						$("#this_month").text(previousmonths2.toFixed(2) / 100);
					}
					//判断以前月
					else if(data[i].rent_order_date<jdates && data[i].rent_order_date.substr(0,data[i].rent_order_date.length-2)==years){
						monthdatas.push(data[i].rent_order_unpaid);
						previousmonths1 += parseFloat(data[i].rent_order_unpaid) * 100;
						$("#before_month").text(previousmonths1.toFixed(2) / 100);
					}
					//判断以前年
					else if(data[i].rent_order_date.substr(0,data[i].rent_order_date.length-2)<years){
						yeardatas.push(data[i].rent_order_unpaid);
						previousmonths += parseFloat(data[i].rent_order_unpaid) * 100;
						$("#before_year").text(previousmonths.toFixed(2) / 100);
					}

					rent_order_date += ',' + data[i].rent_order_date;

				}
				monthdatas = monthdatas.join(',');
				yeardatas = yeardatas.join(',');
				thismonth = thismonth.join(',');
				if(monthdatas==""){
					$("#before_month").text(0);
				}
				if(yeardatas==""){
					$("#before_year").text(0);
				}
				if(thismonth==""){
					$("#this_month").text(0);
				}
				rent_order_date = rent_order_date.replace(/^(\s|,)+|(\s|,)+$/g, '');
				$("input[name='rent_order_date']").val(rent_order_date); //获取被选中的订单
				//总额
				var  before_year =  parseFloat($("#before_year").text()).toFixed(2)*100,
				     before_month = parseFloat($("#before_month").text()).toFixed(2)*100,
					 this_month = parseFloat($("#this_month").text()).toFixed(2)*100;

					 $("#before_year_copy").val(before_year);
				     $("#before_month_copy").val(before_month);
					 $("#this_month_copy").val(this_month);

				previousmonths3 = before_year+before_month+this_month;
				$("#total_sum").text(previousmonths3.toFixed(2) / 100);
          });
		
		//租约
		upload.render({
			elem: '#upload_img2',
			url: upurl1,
			size: 1024*5,
			multiple: duotu,
			field: 'HouseForm',
			before: function(obj) {
				layer.msg('图片上传中...', {
					icon: 16,
					shade: 0.01,
					time: 0
				})
			},
			done: function(res) {
				layer.close(layer.msg()); //关闭上传提示窗口
				if (duotu == true) {
					//调用多图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list2').append('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="HouseForm[]" value="' + res.data.id + '" /></dd>');
				} else {
					//调用单图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list2').html('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="HouseForm[]" value="' + res.data.id + '" /></dd>');
				}
			}
		})
		/*
		删除上传图片
		*/
		$(document).on("click", ".upload_img_list dd i", function() {
			$(this).parents("dd").remove();
		})
	});
</script>
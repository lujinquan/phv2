<link rel="stylesheet" href="__PUBLIC_JS__/viewer/viewer.min.css?v={:config('hisiphp.version')}">
<form class="layui-form" action="" method="post" >
  <div class="j-details-box floorWrap">
	<fieldset class="layui-elem-field layui-field-title j-field-box">
		<legend>基本信息</legend>
	</fieldset>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md4">
			<label class="j-form-label"><i class="red">*</i>注销类别</label>
			<div class="j-input-inline">
				<select name="cancel_type" class="field-cid">
					<option value="">请选择</option>
					{volist name="params['cancels']" id="v"}
					<option value="{$key}" {if condition="$data_info['cancel_type'] == $key"}selected{/if}>{$v}</option>
					{/volist}
				</select>
			</div>
		</div>
		<div class="layui-col-md4">
			<label class="j-form-label"><i class="red">*</i>楼栋查询</label>
			<div class="j-input-inline">
				<input type="text" name="ban_number" value="{$data_info['ban_info']['ban_number']}" readonly placeholder="点击查询" autocomplete="off" class="layui-input">
				<input type="hidden" name="ban_id" value="">
				<input type="hidden" name="house_id" value="">
				<b class="j-explain-search j-ban_number">查询</b>
			</div>
		</div>
		<div class="layui-col-md4">
			<label class="j-form-label">楼栋地址</label>
			<div class="j-input-inline">
				<input type="text" id="ban_address" value="{$data_info['ban_info']['ban_address']}" autocomplete="off" class="layui-input" readonly>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md8">
			<label class="j-form-label">异动事由</label>
			<div class="j-input-inline">
				<input type="text" name="change_remark" value="{$data_info['change_remark']}" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>
	<fieldset  class="layui-elem-field layui-field-title j-field-box">
		<legend>基数异动</legend>
	</fieldset>
		<table  class="layui-table">
		  <thead>
			  <tr>
			    <th>楼栋编号</th>
			    <th>异动状态</th>
			    <th class="cancel">规定租金</th>
			    <th class="cancel">使用面积</th>
			    <th class="cancel">建筑面积</th>
			    <th class="cancel">房屋原价</th>
			    <th>是否注销</th>
			  </tr>
		  </thead>
		  <tbody>
		    <tr>
		  	  <td id="floor_number"></td>
			  <td>异动前</td>
			  <td class="cancel_before_1" id="floor_prescribed"></td>
	    	  <td class="cancel_before_2" id="floor_areaofuse"></td>
	    	  <td class="cancel_before_3" id="floor_builtuparea"></td>
	    	  <td class="cancel_before_4" id="floor_original"></td>
			  <td rowspan="3" align="center"><input type="checkbox" name="cancel_ban" value="1" lay-skin="switch" lay-filter="switchTest" lay-text="ON|OFF"></td>
		    </tr>
			<tr>
			  <td></td>
			  <td>异动</td>
			  <td><input type="number" class="layui-input cancel_change cancel_change_1" id="cancel_rent" name="cancel_rent" value="{$data_info['cancel_rent']}" autocomplete="off" class="layui-input" required></td>
			  <td><input type="number" class="layui-input cancel_change cancel_change_2" id="cancel_use_area" name="cancel_use_area" value="{$data_info['cancel_use_area']}" autocomplete="off" class="layui-input" required></td>
			  <td><input type="number" class="layui-input cancel_change cancel_change_3" id="cancel_area" name="cancel_area" value="{$data_info['cancel_area']}" autocomplete="off" class="layui-input" required></td>
			  <td><input type="number" class="layui-input ancel_change cancel_change_4" id="cancel_oprice" name="cancel_oprice" value="{$data_info['cancel_oprice']}" autocomplete="off" class="layui-input" required></td>
			</tr>
			<tr>
			  <td></td>
			  <td>异动后</td>
			  <td class="cancel_after_1" id="changes_floor_prescribed"></td>
			  <td class="cancel_after_2" id="changes_floor_areaofuse"></td>
			  <td class="cancel_after_3" id="changes_floor_builtuparea"></td>
			  <td class="cancel_after_4" id="changes_floor_original"></td>
			</tr>
		  </tbody>
		</table>
	    <table  class="layui-table hide">
	      <thead>
	    	  <tr>
	    	    <th>楼栋编号</th>
	    	    <th>规定租金</th>
	    	    <th>使用面积</th>
	    	    <th>建筑面积</th>
	    	    <th>房屋原价</th>
	    	  </tr>
	      </thead>
	      <tbody>
	        <tr>
	      	  <td id="floor_number"></td>
	    	  <td id="floor_prescribed"></td>
	    	  <td id="floor_areaofuse"></td>
	    	  <td id="floor_builtuparea"></td>
	    	  <td id="floor_original"></td>
	        </tr>
	      </tbody>
	    </table>
	<fieldset id="item1" class="layui-elem-field layui-field-title j-field-box j-house-title">
		<legend>注销明细</legend>
	</fieldset>
	<table  class="layui-table j-house-box">
	  <thead>
		  <tr>
		    <th>房屋编号</th>
		    <th>承租人</th>
		    <th>房屋原价</th>
		    <th>建筑面积</th>
		    <th>规定租金</th>
		    <th>计租面积</th>
		  </tr>
	  </thead>
	  <tbody>
	  	{volist name="$data_info['data_json']" id="v"}
	  	<tr>
	  		<td>{$v['house_number']}</td>
	  		<td>{$v['tenant_name']}</td>
	  		<td>{$v['tenant_name']}</td>
	  		<td>{$v['tenant_name']}</td>
	  		<td>{$v['tenant_name']}</td>
	  		<td>{$v['tenant_name']}</td>
	  	</tr>
	  	{/volist}
	    <!-- <tr><td colspan='6'><div class='j-no-content'><i class='layui-icon iconfont j-icon-wushuju'></i>暂无数据！</div></td></tr> -->
	 </tbody>
	</table>
	<div class="j-cancel-show hide">
	<!-- <fieldset id="item1" class="layui-elem-field layui-field-title j-field-box">
		<legend>注销楼栋</legend>
	</fieldset>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md4">
			<label class="j-form-label">楼栋编号</label>
			<div class="j-input-inline">
				<input type="text" name="cancel_number" value="" autocomplete="off" class="layui-input">
			</div>
		</div>
		<div class="layui-col-md4">
			<label class="j-form-label">调整面积</label>
			<div class="j-input-inline">
				<input type="text" name="cancel_has" value="" autocomplete="off" class="layui-input">
			</div>
		</div>
	</div>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md12">
			<div class="j-enclosure-upload clearfix">
				<div class="j-enclosure-label">情况说明</div>
				<div class="j-enclosure-label j-uplode-icon">
					<i><img src="__ADMIN_IMG__/Group8.png" /></i>点击上传
					<button type="button" class="layui-btn layui-btn-primary" id="upload_img3">上传图片</button>
				</div>
				<div class="layui-form-mid layui-word-aux">限制1M</div>
			</div>
			<div class="j-enclosure-imgs clearfix">
				<div id="upload_img_list4" class="upload_img_list j-viewer-img"> </div>
			</div>
		</div>
	</div> -->
	</div>
	<fieldset id="item1" class="layui-elem-field layui-field-title j-field-box">
		<legend>补充附件</legend>
	</fieldset>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md12">
			<div class="j-enclosure-upload clearfix">
				<div class="j-enclosure-label">附件一</div>
				<div class="j-enclosure-label j-uplode-icon">
					<i><img src="__ADMIN_IMG__/Group8.png" /></i>点击上传
					<button type="button" class="layui-btn layui-btn-primary" id="upload_img1">上传图片</button>
				</div>
				<div class="layui-form-mid layui-word-aux">限制1M</div>
			</div>
			<div class="j-enclosure-imgs clearfix">
				<div id="upload_img_list2" class="upload_img_list j-viewer-img"> </div>
			</div>
		</div>
	</div>
	<div class="layui-row layui-form-item layui-col-space90">
		<div class="layui-col-md12">
			<div class="j-enclosure-upload clearfix">
				<div class="j-enclosure-label">附件二</div>
				<div class="j-enclosure-label j-uplode-icon">
					<i><img src="__ADMIN_IMG__/Group8.png" /></i>点击上传
					<button type="button" class="layui-btn layui-btn-primary" id="upload_img2">上传图片</button>
				</div>
				<div class="layui-form-mid layui-word-aux">限制1M</div>
			</div>
			<div class="j-enclosure-imgs clearfix">
				<div id="upload_img_list3" class="upload_img_list j-viewer-img"> </div>
			</div>
		</div>
	</div>

  <div class="layui-row layui-form-item layui-col-space90">
		<div class="j-margin-btn">
			<a href="javascript:history.go(-1)" class="layui-btn layui-btn-primary">取消</a>
			<button type="submit" j-data="{'save_type':'save'}" class="layui-btn" lay-submit lay-filter="formSubmit">保存</button>
			<button type="submit" j-data="{'save_type':'submit'}" class="layui-btn" lay-submit lay-filter="formSubmit">保存并提交</button>
		</div>
	</div>
  </div>
</form>
{include file="system@block/layui" /}
<script type="text/javascript" src="__PUBLIC_JS__/viewer/viewer-jquery.min.js?v={:config('hisiphp.version')}"></script>
<script type="text/javascript" src="__ADMIN_VIEWJS__/deal_cancel_apply.js?v={:config('hisiphp.version')}"></script>
<script type="text/javascript">
	var upurl2 = "{:url('system/Api/upload')}?input=ChangeCancelOne&group=change&water=no"; //附件1
	var upurl3 = "{:url('system/Api/upload')}?input=ChangeCancelTwo&group=change&water=no"; //附件2
	//var upurl4 = "{:url('system/Api/upload')}?input=factsheets&group=ban&water=no"; //情况说明
	var duotu = true; //是否为多图上传true false
	layui.use(['jquery', 'laydate', 'upload', 'form'], function() {
		var laydate = layui.laydate,
			$ = layui.$,
			upload = layui.upload,
			form = layui.form;
		//获取楼栋查询器
		 $(".layui-form").on('click','.j-ban_number',function(){
		layer.open({
					title: '楼栋查询器'
					,type: 2
					,offset: 'auto'
					,area: ['70%', '90%']
					, btn:false
					,pageTabs: false
					,content: '{:url('system/index/cancellation')}'
					,btn: ['确定','关闭']
					,yes: function(index, layero){
						var row = window["layui-layer-iframe" + index].callbackdata();
						var rows = window["layui-layer-iframe" + index].callbackdatas();
						var trData = '';
						//console.log(row);
						//console.log(rows);
						layer.close(index);
						$('.j-house-box tbody').html("");
						$("input[name='ban_number']").val(row.ban_number);//获取楼栋编号
						$("input[name='ban_id']").val(row.ban_id);//获取楼栋id
						$("#ban_address").val(row.ban_address);//获取地址
						//楼栋信息
						$("#floor_number").text(row.ban_number);//获取表格楼栋编号
						$("#floor_prescribed").text(row.ban_civil_rent);//获取表格规定租金
						$("#floor_areaofuse").text(row.ban_use_area);//获取表格使用面积
						$("#floor_builtuparea").text(row.ban_civil_area);//获取表格建筑面积
						$("#floor_original").text(row.ban_civil_oprice);//获取表格房屋原价
						$('.j-house-box tbody').html('');
						$('#changes_floor_prescribed').text($('#floor_prescribed').text());//规定租金
						$('#changes_floor_areaofuse').text($('#floor_areaofuse').text());//使用面积
						$('#changes_floor_builtuparea').text($('#floor_builtuparea').text()); //建筑面积
						$('#changes_floor_original').text($('#floor_original').text());//房屋原价
						//房屋信息
						if(rows){
							var houseidData = '';
							for(var i=0;i<rows.length;i++) {
								houseidData += ','+rows[i].house_id;
								var trData ='<tr>\
											<td class="house_number">'+rows[i].house_number+'</td>\
											<td class="house_lessee">'+rows[i].tenant_name+'</td>\
											<td class="house_original">'+rows[i].house_oprice+'</td>\
											<td class="house_builtuparea">'+rows[i].house_area+'</td>\
											<td class="house_prescribed">'+rows[i].house_pre_rent+'</td>\
											<td class="house_rentalarea">'+rows[i].house_lease_area+'</td>\
										</tr>';
							$('.j-house-box tbody').append(trData);
						  }
						  houseidData = houseidData.replace(/^(\s|,)+|(\s|,)+$/g, '');
							$("input[name='house_id']").val(houseidData);//获取房屋编号
						}
						if(	$('.j-house-box tbody').html()==''){
							$(".j-house-box,.j-house-title").hide();
						}
						else{
							$(".j-house-box,.j-house-title").show();
						}
					},btn2: function(index, layero){
						layer.close(index);
					}
		 });
		})
		//待优化
		/* var lengths = $(".cancel").length;
		 for(var i=1;i<=4;i++){
			 //console.log(i);
			 $(".cancel_change_"+i).change(function(){console.log(i);
			 	var sum = parseFloat($('.cancel_before_'+i).text()).toFixed(2)*100 - parseFloat($('.cancel_change_'+i).val()).toFixed(2)*100;
			 	var sum1 = parseFloat($('.cancel_before_'+i).text()).toFixed(2)*100;
			 	if($('.cancel_change_'+i).val()=='')
			 	{
			 		$('.cancel_after_'+i).text(sum1.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+i).val()) < Number($('.cancel_before_'+i).text())){
			 		$('.cancel_after_'+i).text(sum.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+i).val()) >= Number($('.cancel_before_'+i).text())){
			 		$('.cancel_change_'+i).val($('.cancel_before_'+i).text());
			 		$('.cancel_after_'+i).text(0);
			 	}
			 }); 
		 } */
		 
		     var i=1;
		 	 //console.log(i);
		 	 $(".cancel_change_"+i).bind("input propertychange",function(){console.log(i);
		 	 	var sum = parseFloat($('.cancel_before_'+i).text()).toFixed(2)*100 - parseFloat($('.cancel_change_'+i).val()).toFixed(2)*100;
		 	 	var sum1 = parseFloat($('.cancel_before_'+i).text()).toFixed(2)*100;
		 	 	if($('.cancel_change_'+i).val()=='')
		 	 	{
		 	 		$('.cancel_after_'+i).text(sum1.toFixed(2) / 100);
		 	 	}
		 	 	else if(Number($('.cancel_change_'+i).val()) < Number($('.cancel_before_'+i).text())){
		 	 		$('.cancel_after_'+i).text(sum.toFixed(2) / 100);
		 	 	}
		 	 	else if(Number($('.cancel_change_'+i).val()) >= Number($('.cancel_before_'+i).text())){
		 	 		$('.cancel_change_'+i).val($('.cancel_before_'+i).text());
		 	 		$('.cancel_after_'+i).text(0);
		 	 	}
		 	 }); 
			 var j=2;
			 //console.log(i);
			 $(".cancel_change_"+j).bind("input propertychange",function(){console.log(j);
			 	var sum = parseFloat($('.cancel_before_'+j).text()).toFixed(2)*100 - parseFloat($('.cancel_change_'+j).val()).toFixed(2)*100;
			 	var sum1 = parseFloat($('.cancel_before_'+j).text()).toFixed(2)*100;
			 	if($('.cancel_change_'+j).val()=='')
			 	{
			 		$('.cancel_after_'+j).text(sum1.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+j).val()) < Number($('.cancel_before_'+j).text())){
			 		$('.cancel_after_'+j).text(sum.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+j).val()) >= Number($('.cancel_before_'+j).text())){
			 		$('.cancel_change_'+j).val($('.cancel_before_'+j).text());
			 		$('.cancel_after_'+j).text(0);
			 	}
			 }); 
			 var k=3;
			 //console.log(i);
			 $(".cancel_change_"+k).bind("input propertychange",function(){console.log(k);
			 	var sum = parseFloat($('.cancel_before_'+k).text()).toFixed(2)*100 - parseFloat($('.cancel_change_'+k).val()).toFixed(2)*100;
			 	var sum1 = parseFloat($('.cancel_before_'+k).text()).toFixed(2)*100;
			 	if($('.cancel_change_'+k).val()=='')
			 	{
			 		$('.cancel_after_'+k).text(sum1.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+k).val()) < Number($('.cancel_before_'+k).text())){
			 		$('.cancel_after_'+k).text(sum.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+k).val()) >= Number($('.cancel_before_'+k).text())){
			 		$('.cancel_change_'+k).val($('.cancel_before_'+k).text());
			 		$('.cancel_after_'+k).text(0);
			 	}
			 }); 
			 var h=4;
			 //console.log(i);
			 $(".cancel_change_"+h).bind("input propertychange",function(){console.log(h);
			 	var sum = parseFloat($('.cancel_before_'+h).text()).toFixed(2)*100 - parseFloat($('.cancel_change_'+h).val()).toFixed(2)*100;
			 	var sum1 = parseFloat($('.cancel_before_'+h).text()).toFixed(2)*100;
			 	if($('.cancel_change_'+h).val()=='')
			 	{
			 		$('.cancel_after_'+h).text(sum1.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+h).val()) < Number($('.cancel_before_'+h).text())){
			 		$('.cancel_after_'+h).text(sum.toFixed(2) / 100);
			 	}
			 	else if(Number($('.cancel_change_'+h).val()) >= Number($('.cancel_before_'+h).text())){
			 		$('.cancel_change_'+h).val($('.cancel_before_'+h).text());
			 		$('.cancel_after_'+h).text(0);
			 	}
			 });
/* 		//规定租金
		$("#cancel_rent").bind("input propertychange",function(){
			var sum = parseFloat($('#floor_prescribed').text()).toFixed(2)*100 - parseFloat($('#cancel_rent').val()).toFixed(2)*100;
			var sum1 = parseFloat($('#floor_prescribed').text()).toFixed(2)*100;
			if($('#cancel_rent').val()=='')
			{
				$('#changes_floor_prescribed').text(sum1.toFixed(2) / 100);
			}
			else{
				$('#changes_floor_prescribed').text(sum.toFixed(2) / 100);
			}
			
			if($('#cancel_rent').val()=='')
			{
				$('#changes_floor_prescribed').text(sum1.toFixed(2) / 100);
			}
			else if(Number($("#cancel_rent").val()) < Number($("#floor_prescribed").text())){
				$('#changes_floor_prescribed').text(sum.toFixed(2) / 100);
			}
			else if(Number($("#cancel_rent").val()) >= Number($("#floor_prescribed").text())){
				$("#cancel_rent").val($("#floor_prescribed").text());
				$('#changes_floor_prescribed').text(0);
			}
		});
		//使用面积
		$("#cancel_use_area").bind("input propertychange",function(){
			var sum = parseFloat($('#floor_areaofuse').text()).toFixed(2)*100 - parseFloat($('#cancel_use_area').val()).toFixed(2)*100;
			var sum1 = parseFloat($('#floor_areaofuse').text()).toFixed(2)*100;
			if($('#cancel_use_area').val()=='')
			{
				$('#changes_floor_areaofuse').text(sum1.toFixed(2) / 100);
			}
			else if(Number($("#cancel_use_area").val()) < Number($("#floor_areaofuse").text())){
				$('#changes_floor_areaofuse').text(sum.toFixed(2) / 100);
			}
			else if(Number($("#cancel_use_area").val()) >= Number($("#floor_areaofuse").text())){
				$("#cancel_use_area").val($("#floor_areaofuse").text());
				$('#changes_floor_areaofuse').text(0);
			}
		});
		//使用面积
		$("#cancel_use_area").bind("input propertychange",function(){
			var sum = parseFloat($('#floor_areaofuse').text()).toFixed(2)*100 - parseFloat($('#cancel_use_area').val()).toFixed(2)*100;
			var sum1 = parseFloat($('#floor_areaofuse').text()).toFixed(2)*100;
			if($('#cancel_use_area').val()=='')
			{
				$('#changes_floor_areaofuse').text(sum1.toFixed(2) / 100);
			}
			else if(Number($("#cancel_use_area").val()) < Number($("#floor_areaofuse").text())){
				$('#changes_floor_areaofuse').text(sum.toFixed(2) / 100);
			}
			else if(Number($("#cancel_use_area").val()) >= Number($("#floor_areaofuse").text())){
				$("#cancel_use_area").val($("#floor_areaofuse").text());
				$('#changes_floor_areaofuse').text(0);
			}
		});
		//建筑面积
		$("#cancel_area").bind("input propertychange",function(){
			var sum = parseFloat($('#floor_builtuparea').text()).toFixed(2)*100 - parseFloat($('#cancel_use_area').val()).toFixed(2)*100;
			var sum1 = parseFloat($('#floor_builtuparea').text()).toFixed(2)*100;
			if($('#cancel_area').val()=='')
			{
				$('#changes_floor_areaofuse').text(sum1.toFixed(2) / 100);
			}
			else if(Number($("#cancel_area").val()) < Number($("#floor_builtuparea").text())){
				$('#changes_floor_areaofuse').text(sum.toFixed(2) / 100);
			}
			else if(Number($("#cancel_area").val()) >= Number($("#floor_builtuparea").text())){
				$("#cancel_area").val($("#floor_builtuparea").text());
				$('#changes_floor_areaofuse').text(0);
			}
		}); */
		//附件1
		upload.render({
			elem: '#upload_img1',
			url: upurl2,
			size: 1024,
			multiple: duotu,
			field: 'ChangeCancelOne',
			before: function(obj) {
				layer.msg('图片上传中...', {
					icon: 16,
					shade: 0.01,
					time: 0
				})
			},
			done: function(res) {
				layer.close(layer.msg()); //关闭上传提示窗口
				if (duotu == true) {
					//调用多图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list2').append('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="file[]" value="' + res.data.id + '" /></dd>');
				} else {
					//调用单图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list2').html('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="file[]" value="' + res.data.id + '" /></dd>');
				}
			}
		})
		//附件2
		upload.render({
			elem: '#upload_img2',
			url: upurl3,
			size: 1024,
			multiple: duotu,
			field: 'ChangeCancelTwo',
			before: function(obj) {
				layer.msg('图片上传中...', {
					icon: 16,
					shade: 0.01,
					time: 0
				})
			},
			done: function(res) {
				layer.close(layer.msg()); //关闭上传提示窗口
				if (duotu == true) {
					//调用多图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list3').append('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="file[]" value="' + res.data.id + '" /></dd>');
				} else {
					//调用单图上传方法,其中res.imgid为后台返回的一个随机数字
					$('#upload_img_list3').html('<dd class="item_img" id="' + res.data.name +
						'"><div class="operate"><i  class="layui-icon-close-fill layui-icon"></i></div><img src="' + res.data.file +
						'" class="img" ><input type="hidden" name="file[]" value="' + res.data.id + '" /></dd>');
				}
			}
		})
		/*
		删除上传图片
		*/
		$(document).on("click", ".upload_img_list dd i", function() {
			$(this).parents("dd").remove();
		})
	});
</script>
